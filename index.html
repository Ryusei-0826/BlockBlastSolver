<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Block Blast Solver v6.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        cyber: {
                            dark: '#020617',
                            panel: '#0f172a',
                            surface: '#1e293b',
                            primary: '#06b6d4',
                            accent: '#8b5cf6',
                            danger: '#f43f5e',
                            success: '#10b981',
                        }
                    },
                    boxShadow: {
                        'neon': '0 0 10px rgba(6, 182, 212, 0.5), 0 0 20px rgba(6, 182, 212, 0.3)',
                        'neon-accent': '0 0 10px rgba(139, 92, 246, 0.5), 0 0 20px rgba(139, 92, 246, 0.3)',
                        'float': '0 10px 30px -10px rgba(0, 0, 0, 0.6)',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #020617;
            color: #e2e8f0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }
        
        body.scroll-lock {
            overflow: hidden !important;
            height: 100vh;
            touch-action: none;
        }

        .grid-cell {
            position: relative;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.1s ease, border-color 0.1s ease;
            touch-action: none;
        }

        .grid-cell::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 6px;
            background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .filled {
            background: #06b6d4 !important;
            border-color: #22d3ee !important;
            box-shadow: 0 0 12px rgba(6, 182, 212, 0.4);
        }
        .filled::before { opacity: 1; }

        .placed-preview {
            background: #fbbf24 !important;
            border-color: #fbbf24 !important;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
            z-index: 10;
        }

        .cleared-effect {
            animation: flashClear 1.5s infinite;
        }
        @keyframes flashClear {
            0%, 100% { background: #f43f5e; box-shadow: 0 0 15px #f43f5e; }
            50% { background: #fda4af; box-shadow: 0 0 25px #fda4af; }
        }

        .main-board-container {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(6, 182, 212, 0.2);
            box-shadow: 0 0 40px -10px rgba(6, 182, 212, 0.1);
        }

        .bottom-sheet {
            position: fixed;
            left: 0; right: 0; bottom: 0;
            height: 85vh;
            background: #0f172a;
            border-radius: 24px 24px 0 0;
            transform: translateY(110%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 50;
            display: flex;
            flex-direction: column;
            border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .bottom-sheet.active {
            transform: translateY(0);
        }

        .fab-container {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            padding: 20px;
            background: linear-gradient(to top, #0f172a 80%, transparent);
            z-index: 60;
            pointer-events: none;
            display: flex;
            justify-content: center;
        }
        .fab-btn {
            pointer-events: auto;
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(8px);
        }

        .disabled-area {
            opacity: 0.4;
            pointer-events: none;
            filter: grayscale(1);
            transition: all 0.3s;
        }

        .grid-wrapper {
            user-select: none;
            -webkit-user-select: none;
        }
    </style>
</head>
<body class="pb-32 selection:bg-cyan-500 selection:text-white">

    <div class="fixed inset-0 z-[-1] overflow-hidden pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-cyan-900/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-violet-900/20 rounded-full blur-[100px]"></div>
    </div>

    <header class="fixed top-0 left-0 right-0 z-40 bg-cyber-dark/80 backdrop-blur-md border-b border-white/5 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="relative w-8 h-8 flex items-center justify-center bg-cyan-500/10 rounded-lg border border-cyan-500/30">
                <div class="w-4 h-4 bg-cyan-400 rounded-sm shadow-[0_0_10px_#22d3ee]"></div>
            </div>
            <h1 class="text-lg font-bold tracking-tight text-white">Block Blast<span class="text-cyan-400"> Solver</span> <span class="text-[10px] text-slate-500 ml-1 font-mono">v6.2</span></h1>
        </div>
        <button id="menu-btn" class="p-2 rounded-full hover:bg-white/5 active:scale-95 transition text-slate-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </header>

    <div id="menu-backdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300"></div>
    <div id="menu-panel" class="fixed top-0 right-0 bottom-0 w-80 bg-cyber-panel border-l border-white/10 z-50 transform translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
        <div class="p-5 border-b border-white/5 flex justify-between items-center">
            <h2 class="font-bold text-white text-lg">è©³ç´°è¨­å®š</h2>
            <button id="menu-close" class="text-slate-400 hover:text-white p-1">&times;</button>
        </div>
        
        <div class="p-5 flex-1 overflow-y-auto space-y-8">
            <section>
                <div class="flex items-center gap-2 mb-3 text-cyan-400 font-bold text-xs uppercase tracking-widest">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    Algorithm
                </div>
                <div class="space-y-3">
                    <label class="relative flex items-center p-4 rounded-xl border border-white/10 bg-white/5 cursor-pointer hover:bg-white/10 transition group overflow-hidden">
                        <input type="radio" name="mode" value="basic" class="peer sr-only" checked>
                        <div class="absolute inset-0 border-2 border-transparent peer-checked:border-cyan-500 rounded-xl transition"></div>
                        <div class="flex-1">
                            <div class="font-bold text-white mb-0.5 peer-checked:text-cyan-400">åŸºæœ¬ã®è§£æ³•</div>
                            <div class="text-xs text-slate-400">ç”Ÿå­˜æœ€å„ªå…ˆã€‚ã‚³ãƒ³ãƒœã¯è€ƒæ…®ã›ãšã€ã¨ã«ã‹ãç½®ã‘ã‚‹å ´æ‰€ã‚’æ¢ã—ã¾ã™ï¼</div>
                        </div>
                        <div class="w-4 h-4 rounded-full border border-slate-500 peer-checked:bg-cyan-500 peer-checked:border-cyan-500 ml-3"></div>
                    </label>

                    <label class="relative flex items-center p-4 rounded-xl border border-white/10 bg-white/5 cursor-pointer hover:bg-white/10 transition group overflow-hidden">
                        <input type="radio" name="mode" value="beta" class="peer sr-only">
                        <div class="absolute inset-0 border-2 border-transparent peer-checked:border-violet-500 rounded-xl transition"></div>
                        <div class="flex-1">
                            <div class="font-bold text-white mb-0.5 peer-checked:text-violet-400">æœ€å¼·ã®è§£æ³• <span class="text-[10px] bg-violet-500/20 text-violet-300 px-1.5 py-0.5 rounded ml-1">BETA</span></div>
                            <div class="text-xs text-slate-400">ã‚³ãƒ³ãƒœç¶™ç¶šã¨æœªæ¥ã®ç›¤é¢ç¢ºä¿ã‚’é‡è¦–ã€‚æ€è€ƒæ™‚é–“ãŒå°‘ã—ï¼ˆ1ç§’ä»¥å†…ï¼‰é•·ããªã‚Šã¾ã™ï¼</div>
                        </div>
                        <div class="w-4 h-4 rounded-full border border-slate-500 peer-checked:bg-violet-500 peer-checked:border-violet-500 ml-3"></div>
                    </label>
                </div>
            </section>

            <section id="device-settings" class="disabled-area transition-opacity duration-300">
                <div class="flex items-center gap-2 mb-3 text-violet-400 font-bold text-xs uppercase tracking-widest">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    Combo Limit
                </div>
                <div class="bg-white/5 rounded-xl p-1 flex">
                    <label class="flex-1 text-center cursor-pointer relative">
                        <input type="radio" name="device" value="iphone" class="sr-only peer" checked>
                        <div class="py-2.5 text-sm rounded-lg text-slate-400 peer-checked:bg-violet-600 peer-checked:text-white peer-checked:shadow-lg transition z-10 relative">iPhone (3æ‰‹)</div>
                    </label>
                    <label class="flex-1 text-center cursor-pointer relative">
                        <input type="radio" name="device" value="android" class="sr-only peer">
                        <div class="py-2.5 text-sm rounded-lg text-slate-400 peer-checked:bg-violet-600 peer-checked:text-white peer-checked:shadow-lg transition z-10 relative">Android (4æ‰‹)</div>
                    </label>
                </div>
                <p class="text-[10px] text-slate-500 mt-2 px-1">â€» åŸºæœ¬ã®è§£æ³•ã§ã¯ç„¡è¦–ã•ã‚Œã¾ã™</p>
            </section>

            <button id="global-reset" class="w-full py-3 mt-4 rounded-xl border border-red-500/30 text-red-400 bg-red-500/5 hover:bg-red-500/10 transition font-bold flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                å…¨ç›¤é¢ã‚’ãƒªã‚»ãƒƒãƒˆ
            </button>
        </div>
    </div>

    <main class="pt-20 px-4 pb-28 max-w-md mx-auto">
        <section class="mb-8 animate-pop">
            <div class="flex justify-between items-end mb-3 px-2">
                <h2 class="text-sm font-bold text-cyan-400 flex items-center gap-2 uppercase tracking-wider">
                    <span class="w-2 h-2 rounded-full bg-cyan-400 shadow-[0_0_10px_#22d3ee]"></span>
                    Board
                </h2>
                <button onclick="clearGrid('main')" class="text-[10px] font-bold bg-white/10 hover:bg-white/20 text-slate-300 px-3 py-1.5 rounded-full transition">CLEAR</button>
            </div>
            
            <div class="main-board-container rounded-2xl p-4 relative grid-wrapper">
                <div id="main-grid" class="grid grid-cols-8 gap-1 w-full aspect-square"></div>
        </section>

        <section class="animate-pop" style="animation-delay: 0.1s;">
            <div class="flex justify-between items-end mb-3 px-2">
                <h2 class="text-sm font-bold text-violet-400 flex items-center gap-2 uppercase tracking-wider">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z"></path></svg>
                    Pieces
                </h2>
                <button onclick="clearPieces()" class="text-[10px] font-bold bg-white/10 hover:bg-white/20 text-slate-300 px-3 py-1.5 rounded-full transition">CLEAR</button>
            </div>

            <div class="bg-white/5 rounded-2xl p-4 border border-white/5">
                <div class="grid grid-cols-3 gap-3">
                    <div class="piece-container flex flex-col items-center grid-wrapper">
                        <div id="piece-1" class="w-full aspect-square bg-cyber-dark/50 rounded-lg border border-white/10 p-1.5 grid grid-cols-5 gap-[1px]"></div>
                        <span class="text-[10px] text-slate-500 font-mono mt-1.5">Block1</span>
                    </div>
                    <div class="piece-container flex flex-col items-center grid-wrapper">
                        <div id="piece-2" class="w-full aspect-square bg-cyber-dark/50 rounded-lg border border-white/10 p-1.5 grid grid-cols-5 gap-[1px]"></div>
                        <span class="text-[10px] text-slate-500 font-mono mt-1.5">Block2</span>
                    </div>
                    <div class="piece-container flex flex-col items-center grid-wrapper">
                        <div id="piece-3" class="w-full aspect-square bg-cyber-dark/50 rounded-lg border border-white/10 p-1.5 grid grid-cols-5 gap-[1px]"></div>
                        <span class="text-[10px] text-slate-500 font-mono mt-1.5">Block3</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div class="fixed bottom-6 left-0 right-0 px-6 flex justify-center z-30 pointer-events-none">
        <button id="solve-btn" class="pointer-events-auto w-full max-w-sm h-14 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-2xl shadow-neon flex items-center justify-center gap-3 transition-all transform active:scale-95 border border-white/20">
            <span class="tracking-wide text-lg">è§£æ³•å…¥æ‰‹ï¼</span>
            <div id="loading-spinner" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
        </button>
    </div>

    <div id="result-backdrop" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity"></div>
    <div id="result-sheet" class="bottom-sheet">
        <div class="w-full h-10 flex items-center justify-center shrink-0 cursor-pointer" id="sheet-handle">
            <div class="w-12 h-1 bg-slate-600/50 rounded-full"></div>
        </div>

        <div class="px-6 pb-4 flex justify-between items-center shrink-0 border-b border-white/5">
            <div>
                <h2 id="sheet-title" class="text-xl font-bold text-white tracking-tight">è§£æ³•</h2>
                <div class="flex items-center gap-2">
                    <span id="solution-mode-badge" class="text-[10px] px-1.5 py-0.5 rounded bg-cyan-900 text-cyan-400 border border-cyan-800">BASIC</span>
                    <span id="sheet-subtitle" class="text-[10px] text-slate-500"></span>
                </div>
            </div>
            <button id="close-result" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-slate-400 hover:text-white transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div id="results-container" class="flex-1 overflow-y-auto p-6 pb-32 space-y-6"></div>

        <div id="fab-container" class="fab-container">
            <button id="apply-btn" class="fab-btn bg-slate-200/90 hover:bg-white text-slate-900 font-bold py-4 rounded-2xl shadow-float transition-all transform active:scale-95 flex items-center justify-center gap-2 border border-white/50">
                <span>çµæœã‚’åæ˜ ã—ã¦æ¬¡ã¸</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </button>
        </div>
    </div>

    <script>
        const state = {
            board: Array(8).fill().map(() => Array(8).fill(0)),
            pieces: [
                Array(5).fill().map(() => Array(5).fill(0)),
                Array(5).fill().map(() => Array(5).fill(0)),
                Array(5).fill().map(() => Array(5).fill(0))
            ],
            config: {
                mode: 'basic',
                device: 'iphone',
                currentMoves: 0
            },
            currentSolution: null
        };

        const DOM = {
            mainGrid: document.getElementById('main-grid'),
            pieces: [1,2,3].map(i => document.getElementById(`piece-${i}`)),
            solveBtn: document.getElementById('solve-btn'),
            spinner: document.getElementById('loading-spinner'),
            menuBtn: document.getElementById('menu-btn'),
            menuPanel: document.getElementById('menu-panel'),
            menuBackdrop: document.getElementById('menu-backdrop'),
            menuClose: document.getElementById('menu-close'),
            globalReset: document.getElementById('global-reset'),
            modeRadios: document.getElementsByName('mode'),
            deviceRadios: document.getElementsByName('device'),
            deviceSettings: document.getElementById('device-settings'),
            resultSheet: document.getElementById('result-sheet'),
            resultBackdrop: document.getElementById('result-backdrop'),
            closeResultBtn: document.getElementById('close-result'),
            applyBtn: document.getElementById('apply-btn'),
            resultsContainer: document.getElementById('results-container'),
            modeBadge: document.getElementById('solution-mode-badge'),
            sheetTitle: document.getElementById('sheet-title'),
            sheetSubtitle: document.getElementById('sheet-subtitle'),
            fabContainer: document.getElementById('fab-container'),
        };

        function init() {
            renderGrid(DOM.mainGrid, 8, state.board);
            state.pieces.forEach((grid, i) => renderGrid(DOM.pieces[i], 5, grid));
            
            attachDrawHandlers(DOM.mainGrid, () => state.board);
            DOM.pieces.forEach((el, i) => attachDrawHandlers(el, () => state.pieces[i]));

            setupEventListeners();
            updateSettingsUI();
        }

        function renderGrid(container, size, data) {
            container.innerHTML = '';
            for(let r=0; r<size; r++) {
                for(let c=0; c<size; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    if(data[r][c] === 1) cell.classList.add('filled');
                    cell.dataset.r = r;
                    cell.dataset.c = c;
                    container.appendChild(cell);
                }
            }
        }

        function attachDrawHandlers(el, getDataFn) {
            let isDrawing = false;
            let drawType = 1;
            let lastTarget = null;

            const update = (target) => {
                if(!target || target === lastTarget) return;
                lastTarget = target;
                const r = parseInt(target.dataset.r);
                const c = parseInt(target.dataset.c);
                if(isNaN(r)) return;
                const data = getDataFn();
                if(data[r][c] !== drawType) {
                    data[r][c] = drawType;
                    if(drawType===1) target.classList.add('filled');
                    else target.classList.remove('filled');
                    if(navigator.vibrate) navigator.vibrate(5);
                }
            };

            const start = (e) => {
                if(e.cancelable && e.type === 'touchstart') e.preventDefault();
                isDrawing = true;
                lastTarget = null;
                let target = e.target.closest('.grid-cell');
                if(!target && e.touches) {
                    target = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY)?.closest('.grid-cell');
                }
                if(!target || !el.contains(target)) return;
                const r = parseInt(target.dataset.r);
                const c = parseInt(target.dataset.c);
                const data = getDataFn();
                drawType = data[r][c] === 1 ? 0 : 1;
                update(target);
            };

            const move = (e) => {
                if(!isDrawing) return;
                if(e.cancelable) e.preventDefault();
                let clientX, clientY;
                if(e.touches) {
                    clientX = e.touches[0].clientX; clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX; clientY = e.clientY;
                }
                const target = document.elementFromPoint(clientX, clientY);
                if(target && target.closest('.grid-cell') && el.contains(target.closest('.grid-cell'))) {
                    update(target.closest('.grid-cell'));
                }
            };

            const end = () => { isDrawing = false; lastTarget = null; };

            el.addEventListener('touchstart', start, {passive: false});
            el.addEventListener('touchmove', move, {passive: false});
            el.addEventListener('touchend', end);
            el.addEventListener('mousedown', start);
            window.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
        }

        function setupEventListeners() {
            const toggleMenu = (show) => {
                if(show) {
                    DOM.menuBackdrop.classList.remove('hidden');
                    DOM.menuPanel.classList.remove('translate-x-full');
                    requestAnimationFrame(() => DOM.menuBackdrop.classList.remove('opacity-0'));
                } else {
                    DOM.menuPanel.classList.add('translate-x-full');
                    DOM.menuBackdrop.classList.add('opacity-0');
                    setTimeout(() => DOM.menuBackdrop.classList.add('hidden'), 300);
                }
            };
            DOM.menuBtn.onclick = () => toggleMenu(true);
            DOM.menuClose.onclick = () => toggleMenu(false);
            DOM.menuBackdrop.onclick = () => toggleMenu(false);

            Array.from(DOM.modeRadios).forEach(r => {
                r.addEventListener('change', (e) => {
                    state.config.mode = e.target.value;
                    updateSettingsUI();
                });
            });
            Array.from(DOM.deviceRadios).forEach(r => {
                r.addEventListener('change', (e) => {
                    state.config.device = e.target.value;
                });
            });

            window.clearGrid = (type) => {
                if(type === 'main') {
                    state.board = state.board.map(r => r.fill(0));
                    renderGrid(DOM.mainGrid, 8, state.board);
                }
                closeResultSheet();
            };
            window.clearPieces = () => {
                state.pieces.forEach(p => p.map(r => r.fill(0)));
                state.pieces.forEach((grid, i) => renderGrid(DOM.pieces[i], 5, grid));
                closeResultSheet();
            };
            DOM.globalReset.onclick = () => {
                window.clearGrid('main');
                window.clearPieces();
                state.config.currentMoves = 0;
                toggleMenu(false);
            };

            DOM.solveBtn.onclick = runSolver;
            DOM.closeResultBtn.onclick = closeResultSheet;
            DOM.resultBackdrop.onclick = closeResultSheet;
            DOM.applyBtn.onclick = applyResult;
        }

        function updateSettingsUI() {
            if(state.config.mode === 'basic') DOM.deviceSettings.classList.add('disabled-area');
            else DOM.deviceSettings.classList.remove('disabled-area');
        }

        function openResultSheet() {
            DOM.resultBackdrop.classList.remove('hidden');
            requestAnimationFrame(() => {
                DOM.resultBackdrop.classList.remove('opacity-0');
                DOM.resultSheet.classList.add('active');
            });
            document.body.classList.add('scroll-lock');
            DOM.solveBtn.style.transform = 'translateY(200%)';
        }

        function closeResultSheet() {
            DOM.resultSheet.classList.remove('active');
            DOM.resultBackdrop.classList.add('opacity-0');
            setTimeout(() => DOM.resultBackdrop.classList.add('hidden'), 300);
            document.body.classList.remove('scroll-lock');
            DOM.solveBtn.style.transform = 'translateY(0)';
        }

        // å¤‰æ›´ç‚¹: ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆå½¢å¼ã®ã‚¨ãƒ©ãƒ¼/è­¦å‘Šè¡¨ç¤ºé–¢æ•°
        function renderError(title, message, isWarning = false) {
            DOM.resultsContainer.innerHTML = '';
            DOM.sheetTitle.innerText = title;
            DOM.sheetSubtitle.innerText = 'Attention Required';
            
            DOM.modeBadge.innerText = isWarning ? 'WARNING' : 'FAILED';
            DOM.modeBadge.className = isWarning 
                ? 'text-[10px] px-1.5 py-0.5 rounded bg-amber-900 text-amber-400 border border-amber-800'
                : 'text-[10px] px-1.5 py-0.5 rounded bg-red-900 text-red-400 border border-red-800';

            const card = document.createElement('div');
            card.className = `p-6 ${isWarning ? 'bg-amber-500/10 border-amber-500/30' : 'bg-red-500/10 border-red-500/30'} border rounded-2xl text-center space-y-4 animate-pop`;
            
            card.innerHTML = `
                <div class="text-5xl mb-2">${isWarning ? 'ï¸â“' : 'âŒ'}</div>
                <h3 class="text-xl font-bold ${isWarning ? 'text-amber-400' : 'text-red-400'}">${title}</h3>
                <p class="text-slate-300 text-sm leading-relaxed">${message}</p>
            `;
            
            DOM.resultsContainer.appendChild(card);
            DOM.fabContainer.style.display = 'none'; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åæ˜ ãƒœã‚¿ãƒ³ä¸è¦
            openResultSheet();
        }

        async function runSolver() {
            DOM.solveBtn.disabled = true;
            DOM.spinner.classList.remove('hidden');
            await new Promise(r => setTimeout(r, 50));

            const board = JSON.parse(JSON.stringify(state.board));
            const activePieces = [];
            state.pieces.forEach((g, i) => {
                const s = trimGrid(g);
                if(s) activePieces.push({id: i, shape: s});
            });

            if(activePieces.length === 0) {
                // å¤‰æ›´ç‚¹: alertã‚’å»ƒæ­¢ã—ã€ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º
                renderError('å…¥åŠ›ãŒå¿…è¦ã§ã™ï¼', 'ãƒ”ãƒ¼ã‚¹å…¥åŠ›ã‚¨ãƒªã‚¢ã«ã€ç¾åœ¨æŒã£ã¦ã„ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
                DOM.solveBtn.disabled = false;
                DOM.spinner.classList.add('hidden');
                return;
            }

            const result = solveLogic(board, activePieces, state.config);

            if(result.success) {
                state.currentSolution = result;
                DOM.sheetTitle.innerText = 'æœ€é©ãªè§£æ³•';
                DOM.sheetSubtitle.innerText = 'AI Analysis Complete';
                renderResult(result);
                DOM.fabContainer.style.display = 'flex';
                openResultSheet();
            } else {
                renderError('è©°ã‚“ã§ã„ã¾ã™ï¼', 'ç¾åœ¨ã®ç›¤é¢ã¨ãƒ”ãƒ¼ã‚¹ã®çµ„ã¿åˆã‚ã›ã§ã¯ã€ã“ã‚Œä»¥ä¸Šé…ç½®ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚');
            }

            DOM.solveBtn.disabled = false;
            DOM.spinner.classList.add('hidden');
        }

        function trimGrid(grid) {
            const cells = [];
            for(let r=0; r<5; r++) for(let c=0; c<5; c++) if(grid[r][c]) cells.push({r,c});
            if(cells.length === 0) return null;
            const minR = Math.min(...cells.map(c=>c.r));
            const minC = Math.min(...cells.map(c=>c.c));
            return cells.map(c => ({r: c.r-minR, c: c.c-minC}));
        }

        function solveLogic(initialBoard, pieces, config) {
            const perms = getPermutations(pieces);
            let bestScore = -Infinity;
            let bestPath = null;
            const beamWidth = config.mode === 'beta' ? 12 : 5; 
            for(const order of perms) {
                const res = beamSearch(initialBoard, order, 0, config.currentMoves, beamWidth, config);
                if(res.score > bestScore) { bestScore = res.score; bestPath = res; }
            }
            if(!bestPath || bestPath.dead) return { success: false };
            return { success: true, steps: bestPath.history, finalBoard: bestPath.board };
        }

        function beamSearch(board, pieces, depth, currentMoves, width, config) {
            if(pieces.length === 0) return { score: 0, board, history: [], dead: false };
            const p = pieces[0];
            const moves = getValidMoves(board, p.shape);
            if(moves.length === 0) return { score: -999999, board, history: [], dead: true };
            const candidates = moves.map(pos => {
                const sim = simulate(board, p.shape, pos);
                const score = evaluate(sim, depth, pieces.length===1, currentMoves, config);
                return { pos, sim, score };
            });
            candidates.sort((a,b) => b.score - a.score);
            const top = candidates.slice(0, width);
            let maxS = -Infinity;
            let best = null;
            for(const cand of top) {
                let nextMoves = currentMoves;
                if(cand.sim.lines > 0) nextMoves = 0; else nextMoves++;
                const res = beamSearch(cand.sim.board, pieces.slice(1), depth+1, nextMoves, width, config);
                let total = cand.score + res.score;
                if(res.dead) total -= 50000;
                if(total > maxS) {
                    maxS = total;
                    best = { score: total, board: res.board, dead: res.dead, history: [{
                        pieceId: p.id, shape: p.shape, pos: cand.pos, boardBefore: board,
                        cleared: cand.sim.cleared, lines: cand.sim.lines, comboStat: nextMoves
                    }, ...res.history] };
                }
            }
            if(!best) return { score: -999999, board, history: [], dead: true };
            return best;
        }

        function getValidMoves(board, shape) {
            const res = [];
            const sH = Math.max(...shape.map(p=>p.r))+1;
            const sW = Math.max(...shape.map(p=>p.c))+1;
            for(let r=0; r<=8-sH; r++) for(let c=0; c<=8-sW; c++) {
                if(shape.every(p => board[r+p.r][c+p.c]===0)) res.push({r,c});
            }
            return res;
        }

        function simulate(board, shape, pos) {
            const nb = board.map(r=>[...r]);
            shape.forEach(p => nb[pos.r+p.r][pos.c+p.c] = 1);
            const rows=[], cols=[];
            for(let r=0; r<8; r++) if(nb[r].every(v=>v===1)) rows.push(r);
            for(let c=0; c<8; c++) if(nb.every(r=>r[c]===1)) cols.push(c);
            if(rows.length||cols.length) {
                for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(rows.includes(r)||cols.includes(c)) nb[r][c] = 0;
            }
            return { board: nb, lines: rows.length+cols.length, cleared: {rows, cols} };
        }

        function evaluate(sim, depth, isLast, currentMoves, config) {
            let s = 0;
            const { board, lines } = sim;
            const isBeta = config.mode === 'beta';
            if(lines > 0) { s += 1000 * lines; if(isBeta) s += 200; }
            s += countEmpty(board) * 10;
            s -= countHoles(board) * 100;
            if(isBeta) {
                const limit = config.device === 'iphone' ? 3 : 4;
                if(lines === 0) s -= 2000 * Math.pow((currentMoves + 1) / limit, 2);
                if(isLast) {
                    s += lines > 0 ? 2500 : (currentMoves < limit - 1 ? 500 : 0);
                    s += evaluateSpace(board) * 3.0; 
                } else {
                    if(lines === 1) s += 500;
                    s += evaluateSpace(board);
                }
            }
            return s;
        }

        function countEmpty(b) { let n=0; for(let r of b) for(let v of r) if(v===0) n++; return n; }
        function countHoles(b) {
            let h=0;
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) if(b[r][c]===0) {
                let w=0;
                if(r===0||b[r-1][c]) w++; if(r===7||b[r+1][c]) w++;
                if(c===0||b[r][c-1]) w++; if(c===7||b[r][c+1]) w++;
                if(w===4) h++;
            }
            return h;
        }

        function evaluateSpace(b) {
            let score = 0;
            let has3x3 = false;
            for(let r=0; r<=5; r++) {
                for(let c=0; c<=5; c++) if([0,1,2].every(dr=>[0,1,2].every(dc=>b[r+dr][c+dc]===0))) { has3x3 = true; break; }
                if(has3x3) break;
            }
            if(has3x3) score += 2000;
            let hasH5=false, hasV5=false;
            for(let r=0; r<8; r++) for(let c=0; c<=3; c++) if([0,1,2,3,4].every(k=>b[r][c+k]===0)) hasH5=true;
            for(let c=0; c<8; c++) for(let r=0; r<=3; r++) if([0,1,2,3,4].every(k=>b[r+k][c]===0)) hasV5=true;
            if(hasH5) score += 800; if(hasV5) score += 800;
            return score;
        }

        function getPermutations(arr) {
            if(arr.length<=1) return [arr];
            const res=[];
            for(let i=0; i<arr.length; i++) {
                const rest = [...arr.slice(0,i), ...arr.slice(i+1)];
                for(const p of getPermutations(rest)) res.push([arr[i], ...p]);
            }
            return res;
        }

        function renderResult(res) {
            DOM.modeBadge.innerText = state.config.mode === 'beta' ? 'BETA (AI)' : 'BASIC';
            DOM.modeBadge.className = state.config.mode === 'beta' 
                ? 'text-[10px] px-1.5 py-0.5 rounded bg-violet-900 text-violet-400 border border-violet-800'
                : 'text-[10px] px-1.5 py-0.5 rounded bg-cyan-900 text-cyan-400 border border-cyan-800';
            const limit = state.config.device === 'iphone' ? 3 : 4;
            DOM.resultsContainer.innerHTML = '';
            res.steps.forEach((step, i) => {
                const isLast = i === res.steps.length - 1;
                const card = document.createElement('div');
                card.className = `result-card rounded-2xl p-4 border relative overflow-hidden group ${isLast ? 'bg-gradient-to-br from-white/5 to-cyan-900/10 border-cyan-500/20 shadow-neon' : 'bg-white/5 border-white/5'}`;
                const badge = document.createElement('div');
                badge.className = `absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-xs font-bold font-mono ${isLast ? 'bg-cyan-600 text-white shadow-lg' : 'bg-slate-800 text-slate-400'}`;
                badge.innerText = `STEP ${String(i+1).padStart(2, '0')}`;
                card.appendChild(badge);
                const content = document.createElement('div');
                content.className = 'flex gap-4 items-center';
                const previewBox = document.createElement('div');
                previewBox.className = `w-24 shrink-0 aspect-square bg-cyber-dark/80 rounded-lg p-1 ${isLast ? 'border border-cyan-500/30' : ''}`;
                const gridDiv = document.createElement('div');
                gridDiv.className = 'w-full h-full grid grid-cols-8 gap-[1px]';
                for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'w-full h-full rounded-[1px] transition-colors duration-300';
                    cell.style.backgroundColor = step.boardBefore[r][c] ? '#334155' : '#020617';
                    if(step.shape.some(p => p.r+step.pos.r === r && p.c+step.pos.c === c)) cell.className += ' placed-preview';
                    if(step.cleared.rows.includes(r) || step.cleared.cols.includes(c)) cell.className += ' cleared-effect';
                    gridDiv.appendChild(cell);
                }
                previewBox.appendChild(gridDiv);
                content.appendChild(previewBox);
                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex-1';
                const descP = document.createElement('div');
                descP.className = 'font-bold text-sm mb-2 text-slate-200';
                const tagSpan = document.createElement('div');
                if(step.lines > 0) {
                    descP.innerHTML = `<span class="text-white">Block ${step.pieceId+1}</span>ã§ <span class="text-rose-400">ğŸ’¥ ${step.lines}ãƒ©ã‚¤ãƒ³æ¶ˆå»</span>`;
                    tagSpan.className = 'bg-cyan-500/10 text-cyan-400 border border-cyan-500/30 px-2 py-0.5 rounded text-xs inline-block';
                    tagSpan.innerHTML = 'âœ¨ Combo Active';
                } else {
                    descP.innerHTML = `<span class="text-white">Block ${step.pieceId+1}</span>ã‚’é…ç½®`;
                    if(state.config.mode === 'beta') {
                        const movesLeft = limit - step.comboStat;
                        tagSpan.className = movesLeft <= 1 ? 'bg-rose-500/10 text-rose-400 border border-rose-500/30 px-2 py-0.5 rounded text-xs inline-block' : 'bg-slate-700 text-slate-400 px-2 py-0.5 rounded text-xs inline-block';
                        tagSpan.innerHTML = `çŒ¶äºˆæ®‹ã‚Š: ${movesLeft}æ‰‹`;
                    } else tagSpan.style.display = 'none';
                }
                infoDiv.appendChild(descP);
                infoDiv.appendChild(tagSpan);
                if(isLast && state.config.mode === 'beta' && step.lines === 0) {
                    const note = document.createElement('div');
                    note.className = 'text-[10px] text-cyan-400 mt-1 bg-cyan-950/40 px-2 py-1 rounded border border-cyan-500/20';
                    note.innerHTML = 'ğŸ›¡ï¸ æ•´åœ°å„ªå…ˆ: æ¬¡ã‚¿ãƒ¼ãƒ³ã®å®‰å…¨ã‚’ç¢ºä¿ã—ã¾ã—ãŸ';
                    infoDiv.appendChild(note);
                }
                content.appendChild(infoDiv);
                card.appendChild(content);
                DOM.resultsContainer.appendChild(card);
            });
            const spacer = document.createElement('div'); spacer.className = 'h-8';
            DOM.resultsContainer.appendChild(spacer);
        }

        function applyResult() {
            if(!state.currentSolution) return;
            state.board = state.currentSolution.finalBoard;
            renderGrid(DOM.mainGrid, 8, state.board);
            const lastStep = state.currentSolution.steps[state.currentSolution.steps.length - 1];
            state.config.currentMoves = lastStep.comboStat;
            window.clearPieces();
            closeResultSheet();
            window.scrollTo({top:0, behavior:'smooth'});
        }

        init();
    </script>
</body>
</html>